# !/usr/bin/python3
import time
import requests
import json

from bs4 import BeautifulSoup

# 刷课间隔（秒）
SLEEP_TIME = 1

# 课程 ID
COURSE_ID = ''

# 学习时间（建议不改）
STUDY_TIME = '300'

# `learningTime_save` 请求标头 Cookie
COOKIE = ''

if COURSE_ID == '':
    print('请配置 COURSE_ID 后再次运行')
    exit()

if COOKIE == '':
    print('请配置 COOKIE 后再次运行')
    exit()

# 打开文件
html = open('issuee.html', mode='r', encoding='utf-8').read()

# 解析为 HTML
document = BeautifulSoup(html, 'html.parser')


# 遍历章
def get_chapters_title():
    chapters_list = []
    for e in document.select('div[id^="s_chapter_"]'):
        chapters_list.append(e.get('title'))
    return chapters_list


# 遍历讲
def get_sections_title():
    sections_list = []
    for e in document.select('div[id^="s_section_"]'):
        sections_list.append(e.get('title'))
    return sections_list


# 遍历讲下节点和资源
def get_points():
    points_list = []
    for e in document.select('div[id^="s_point_"]'):
        # 获取 id 并去掉 s_point_ 前缀
        item_id = e.get('id')[8:]
        if e.select('div[class="s_pointti"]'):
            title = e.select('div[class="s_pointti"]')[0].contents[0].text
        else:
            title = e.select('div[class="s_pointtitle"]')[0].contents[0].text
        points_list.append(Point(item_id, title if title else "未知标题"))
    return points_list


class Point:
    itemId = ''
    title = ''

    def __init__(self, item_id, title):
        self.itemId = item_id
        self.title = title

    def __str__(self):
        return self.title + "：" + self.itemId


for i in get_points():
    print(i)
    course_id = requests.get(
        url='https://course.icve.com.cn/learnspace/course/study/learningTime_queryCourseItemInfo.action',
        headers={'Cookie': COOKIE},
        params={'itemId': i.itemId},
    ).text
    print(course_id)
    print(requests.post(
        url='https://course.icve.com.cn/learnspace/course/study/learningTime_saveCourseItemLearnRecord.action',
        # cookies=COOKIE,
        headers={
            # "cookie": COOKIE,
            "Cookie": COOKIE,
            # "Accept": "*/*",
            # "Accept-Encoding": "gzip, deflate, br",
            # "Accept-Language": "zh-CN,zh;q=0.9",
            # "Connection": "keep-alive",
            # "Content-Type": "multipart/form-data",
            # "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/92.0.4515.159 Safari/537.36",
            # "Referer": "https://course.icve.com.cn/learnspace/learn/learn/templateeight/content_doc.action?params.courseId=6937939f1dfe4af7aef45cc9dcc2459e___&params.itemId=402883a982e2a5660182f2f78269381c&params.templateStyleType=0&params.parentId=1563079671446114306&_t=1667738504796"
        },
        data={
            "courseId": COURSE_ID,
            "studyTime": STUDY_TIME,
            "itemId": i.itemId,
            "recordType": "0"
        },
    ).text)

    time.sleep(SLEEP_TIME)
